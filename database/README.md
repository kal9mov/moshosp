# База данных MOSHOSP

Данная директория содержит схему базы данных для проекта MOSHOSP, включая SQL-скрипты для создания таблиц, миграций и начальных данных для разработки.

## Структура базы данных

База данных PostgreSQL используется для хранения всех данных приложения, включая:

- Информацию о пользователях и волонтерах
- Заявки на помощь и их статусы
- Систему достижений и игрофикации
- Уведомления и статистику

## Содержимое директории

- `schema.sql` - Полная схема базы данных в виде единого SQL-файла
- `migrations/` - Инкрементальные миграции базы данных
  - `001_initial_schema.sql` - Начальная структура базы данных
  - `002_seed_data.sql` - Начальные тестовые данные
  - `003_add_views.sql` - Представления для упрощения запросов

## Модель данных

### Основные таблицы

- `users` - Пользователи системы (получатели помощи, волонтеры, администраторы)
- `user_stats` - Статистика пользователей (уровень, опыт, рейтинг и т.д.)
- `help_requests` - Заявки на помощь
- `request_categories` - Категории заявок
- `request_comments` - Комментарии к заявкам
- `request_ratings` - Оценки выполненных заявок
- `achievements` - Достижения в системе
- `user_achievements` - Достижения пользователей
- `notifications` - Уведомления для пользователей
- `partner_organizations` - Партнерские организации

### Представления (Views)

- `user_full_info` - Информация о пользователях с расширенной статистикой
- `request_full_info` - Информация о заявках с данными пользователей
- `system_stats` - Общая статистика системы
- `user_achievements_info` - Информация о достижениях пользователей
- `leaderboard_experience` - Лидерборд по опыту
- `leaderboard_requests` - Лидерборд по выполненным заявкам
- `notifications_info` - Информация об уведомлениях с дополнительными данными

## Как использовать миграции

Для управления миграциями используется инструмент [golang-migrate](https://github.com/golang-migrate/migrate).

### Создание новой миграции

```bash
migrate create -ext sql -dir migrations -seq название_миграции
```

### Применение миграций

```bash
migrate -database "postgres://username:password@localhost:5432/moshosp?sslmode=disable" -path migrations up
```

### Откат миграций

```bash
migrate -database "postgres://username:password@localhost:5432/moshosp?sslmode=disable" -path migrations down
```

## Работа с базой данных в Docker

База данных запускается в Docker контейнере с помощью docker-compose. Для запуска:

```bash
docker-compose up -d postgres
```

Для доступа к PostgreSQL через psql:

```bash
docker-compose exec postgres psql -U postgres -d moshosp
```

## Начальные данные для разработки

Миграция `002_seed_data.sql` содержит тестовые данные для локальной разработки:

- 3 пользователя с разными ролями (пользователь, волонтер, администратор)
- Набор категорий запросов
- Тестовые заявки на помощь
- Базовые достижения
- Статистику пользователей

## Особенности

- Поддержка мягкого удаления (soft delete) для пользователей и запросов
- Полнотекстовый поиск по запросам на помощь
- Триггеры для автоматического обновления дат изменения
- Оптимизированные индексы для частых запросов

## Подключение к базе данных

Для подключения к базе данных используются следующие параметры:

- Хост: `localhost` (или `postgres` в docker-сети)
- Порт: `5432`
- Имя БД: `moshosp`
- Пользователь: `postgres`
- Пароль: Задается в .env файле или docker-compose.yml 